<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kanban CGF</title>
<style>
  body { font-family: Arial, sans-serif; background: #f7f9fb; margin: 0; padding: 0; }
  header { display: flex; align-items: center; justify-content: space-between; background: #004080; color: #fff; padding: 10px 20px; }
  header img { height: 40px; }
  h1 { font-size: 20px; margin: 0; }
  .kanban-board { display: flex; gap: 10px; padding: 20px; overflow-x: auto; }
  .kanban-column { background: #e8ecf1; flex: 1; border-radius: 8px; padding: 10px; min-width: 250px; display: flex; flex-direction: column; }
  .column-header { font-weight: bold; color: #fff; text-align: center; padding: 8px; border-radius: 6px; margin-bottom: 10px; }
  .red { background: #e74c3c; } .yellow { background: #f1c40f; } .blue { background: #3498db; } .green { background: #27ae60; }
  .task-card { background: #fff; border-radius: 6px; padding: 10px; margin-bottom: 10px; cursor: grab; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  .task-card.dragging { opacity: 0.5; }
  .task-title { font-weight: bold; color: #333; }
  .task-desc, .task-meta { font-size: 13px; color: #555; margin-top: 5px; }
  .add-task-btn { background: #004080; color: #fff; border: none; border-radius: 5px; padding: 5px; cursor: pointer; margin-top: auto; }
  .modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
  .modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 300px; }
  .modal input, .modal textarea { width: 100%; margin-bottom: 10px; padding: 6px; }
  .btn-group { display: flex; gap: 10px; margin: 10px; justify-content: flex-end; }
  .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; color: #fff; }
  .btn.whatsapp { background: #25d366; } .btn.pdf { background: #d32f2f; }
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:10px;">
    <img src="logo-cgf.png" alt="Logo CGF">
    <h1>KANBAN - Gestão de Atividades CGF</h1>
  </div>
  <div class="btn-group">
    <button class="btn whatsapp" onclick="exportToWhatsApp()">📱 WhatsApp</button>
    <button class="btn pdf" onclick="exportToPDF()">📄 PDF</button>
  </div>
</header>

<div class="kanban-board">
  <div class="kanban-column" data-status="todo">
    <div class="column-header red">A FAZER</div>
    <div class="task-list" id="todo-list"></div>
    <button class="add-task-btn" onclick="openModal('todo')">+ Adicionar Tarefa</button>
  </div>

  <div class="kanban-column" data-status="progress">
    <div class="column-header yellow">EM ANDAMENTO</div>
    <div class="task-list" id="progress-list"></div>
    <button class="add-task-btn" onclick="openModal('progress')">+ Adicionar Tarefa</button>
  </div>

  <div class="kanban-column" data-status="review">
    <div class="column-header blue">EM REVISÃO</div>
    <div class="task-list" id="review-list"></div>
    <button class="add-task-btn" onclick="openModal('review')">+ Adicionar Tarefa</button>
  </div>

  <div class="kanban-column" data-status="done">
    <div class="column-header green">CONCLUÍDO</div>
    <div class="task-list" id="done-list"></div>
    <button class="add-task-btn" onclick="openModal('done')">+ Adicionar Tarefa</button>
  </div>
</div>

<!-- Modal -->
<div id="taskModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Nova Tarefa</h3>
    <input type="text" id="taskTitle" placeholder="Título">
    <textarea id="taskDesc" placeholder="Descrição"></textarea>
    <input type="text" id="taskResp" placeholder="Responsável">
    <input type="date" id="taskDeadline">
    <button onclick="saveTask()">Salvar</button>
    <button onclick="closeModal()">Cancelar</button>
  </div>
</div>

<script>
let currentStatus = '';
let editingCard = null;

// ---------- Modal ----------
function openModal(status, card = null) {
  currentStatus = status;
  editingCard = card;
  document.getElementById('taskModal').style.display = 'flex';
  if (card) {
    document.getElementById('modalTitle').innerText = 'Editar Tarefa';
    document.getElementById('taskTitle').value = card.querySelector('.task-title').textContent;
    document.getElementById('taskDesc').value = card.querySelector('.task-desc').textContent;
    document.getElementById('taskResp').value = card.querySelector('.task-resp').textContent.replace('👤 ','');
    document.getElementById('taskDeadline').value = card.querySelector('.task-deadline').textContent.replace('📅 ','');
  } else {
    document.getElementById('modalTitle').innerText = 'Nova Tarefa';
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDesc').value = '';
    document.getElementById('taskResp').value = '';
    document.getElementById('taskDeadline').value = '';
  }
}

function closeModal() {
  document.getElementById('taskModal').style.display = 'none';
  editingCard = null;
}

// ---------- Criar Card ----------
function createTaskCard(title, desc, resp, deadline, color) {
  const card = document.createElement('div');
  card.className = 'task-card';
  card.setAttribute('draggable', true);
  card.innerHTML = `
    <div class="task-title">${title}</div>
    <div class="task-desc">${desc || ''}</div>
    <div class="task-meta">
      <div class="task-resp">👤 ${resp || ''}</div>
      <div class="task-deadline">📅 ${deadline || ''}</div>
    </div>
  `;
  card.ondblclick = () => openModal(currentStatus, card);
  return card;
}

// ---------- Salvar / Editar ----------
function saveTask() {
  const title = document.getElementById('taskTitle').value.trim();
  const desc = document.getElementById('taskDesc').value.trim();
  const resp = document.getElementById('taskResp').value.trim();
  const deadline = document.getElementById('taskDeadline').value.trim();
  if (!title) return alert('Informe o título da tarefa.');

  if (editingCard) {
    editingCard.querySelector('.task-title').textContent = title;
    editingCard.querySelector('.task-desc').textContent = desc;
    editingCard.querySelector('.task-resp').textContent = '👤 ' + resp;
    editingCard.querySelector('.task-deadline').textContent = '📅 ' + deadline;
  } else {
    const color = getColorByStatus(currentStatus);
    const card = createTaskCard(title, desc, resp, deadline, color);
    document.getElementById(`${currentStatus}-list`).appendChild(card);
  }

  saveTasksToLocalStorage();
  closeModal();
}

// ---------- Drag & Drop ----------
let draggedTask = null;
document.addEventListener('dragstart', e => {
  if (e.target.classList.contains('task-card')) {
    draggedTask = e.target;
    e.target.classList.add('dragging');
  }
});
document.addEventListener('dragend', e => {
  if (draggedTask) {
    draggedTask.classList.remove('dragging');
    draggedTask = null;
    saveTasksToLocalStorage();
  }
});
document.querySelectorAll('.task-list').forEach(list => {
  list.addEventListener('dragover', e => e.preventDefault());
  list.addEventListener('drop', e => {
    e.preventDefault();
    if (draggedTask) {
      list.appendChild(draggedTask);
      saveTasksToLocalStorage();
    }
  });
});

// ---------- LocalStorage ----------
function getAllTasks() {
  const lists = ['todo', 'progress', 'review', 'done'];
  const tasks = {};
  lists.forEach(id => {
    tasks[id] = Array.from(document.querySelectorAll(`#${id}-list .task-card`)).map(card => ({
      title: card.querySelector('.task-title').textContent,
      description: card.querySelector('.task-desc').textContent,
      responsible: card.querySelector('.task-resp').textContent.replace('👤 ',''),
      deadline: card.querySelector('.task-deadline').textContent.replace('📅 ','')
    }));
  });
  return tasks;
}
function saveTasksToLocalStorage() {
  localStorage.setItem('kanbanTasks', JSON.stringify(getAllTasks()));
}
function loadTasksFromLocalStorage() {
  const saved = localStorage.getItem('kanbanTasks');
  if (saved) {
    const tasks = JSON.parse(saved);
    Object.keys(tasks).forEach(status => {
      tasks[status].forEach(t => {
        const color = getColorByStatus(status);
        const card = createTaskCard(t.title, t.description, t.responsible, t.deadline, color);
        document.getElementById(`${status}-list`).appendChild(card);
      });
    });
  }
}
function getColorByStatus(status) {
  switch(status) {
    case 'todo': return 'red';
    case 'progress': return 'yellow';
    case 'review': return 'blue';
    case 'done': return 'green';
  }
}

// ---------- Exportar PDF ----------
function exportToPDF() {
  const tasks = getAllTasks();
  const date = new Date().toLocaleDateString('pt-BR');
  let html = `
  <html><head><style>
  body{font-family:Arial,sans-serif;padding:20px;}
  h1{color:#004080;text-align:center;}
  .section{margin-bottom:20px;}
  .section-title{padding:6px;color:#fff;border-radius:4px;margin-bottom:8px;}
  .red{background:#e74c3c}.yellow{background:#f1c40f}.blue{background:#3498db}.green{background:#27ae60}
  .task{border-left:5px solid;padding:6px 10px;margin-bottom:6px;background:#f9f9f9;border-radius:4px;}
  </style></head><body>
  <h1>📋 Kanban CGF - ${date}</h1>`;
  const sections = [
    { key: 'todo', title: 'A FAZER', color: 'red' },
    { key: 'progress', title: 'EM ANDAMENTO', color: 'yellow' },
    { key: 'review', title: 'EM REVISÃO', color: 'blue' },
    { key: 'done', title: 'CONCLUÍDO', color: 'green' }
  ];
  sections.forEach(s => {
    html += `<div class="section"><div class="section-title ${s.color}">${s.title}</div>`;
    tasks[s.key].forEach(t => {
      html += `<div class="task" style="border-color:${s.color}"><b>${t.title}</b><br>${t.description || ''}<br>👤 ${t.responsible || '-'} | 📅 ${t.deadline || '-'}</div>`;
    });
    html += `</div>`;
  });
  html += `</body></html>`;
  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  w.print();
}

// ---------- WhatsApp ----------
function exportToWhatsApp() {
  const tasks = getAllTasks();
  const date = new Date().toLocaleDateString('pt-BR');
  let msg = `📋 KANBAN CGF - Atualizado em ${date}\n\n`;
  const sections = [
    { key: 'todo', emoji: '🔴 A FAZER' },
    { key: 'progress', emoji: '🟡 EM ANDAMENTO' },
    { key: 'review', emoji: '🔵 EM REVISÃO' },
    { key: 'done', emoji: '🟢 CONCLUÍDO' }
  ];
  sections.forEach(s => {
    msg += `${s.emoji} (${tasks[s.key].length})\n`;
    tasks[s.key].forEach(t => {
      msg += `• ${t.title}\n`;
      if (t.description) msg += `${t.description}\n`;
      if (t.responsible) msg += `👤 ${t.responsible}\n`;
      if (t.deadline) msg += `📅 ${t.deadline}\n`;
    });
    msg += `\n`;
  });
  window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
}

window.onclick = e => { const modal = document.getElementById('taskModal'); if (e.target === modal) closeModal(); };
document.addEventListener('DOMContentLoaded', loadTasksFromLocalStorage);
</script>
</body>
</html>
